(function(d,te,m,p,v,O,N,y,l,R,e,f,o,M,z){"use strict";const{TextStyleSheet:ne}=R.findByProps("TextStyleSheet"),{View:E,Text:L}=o.General,{FormRow:ae}=o.Forms;function ie(t){const n=R.findByProps("colors","meta"),a=R.findByStoreName("ThemeStore");return n.meta.resolveSemanticColor(a.theme,t)}function I(t){let{title:n,icon:a,children:i,padding:s}=t;const c=e.stylesheet.createThemedStyleSheet({mainText:{fontFamily:e.constants.Fonts.PRIMARY_SEMIBOLD,fontSize:14,includeFontPadding:!1,letterSpacing:void 0,lineHeight:18,textTransform:"none",color:f.semanticColors.HEADER_SECONDARY},main:{backgroundColor:f.semanticColors.BACKGROUND_TERTIARY,borderRadius:16,overflow:"hidden",flex:1}});return e.React.createElement(E,{style:{marginHorizontal:16,marginTop:16}},e.React.createElement(E,{style:{marginBottom:8,flexDirection:"row",justifyContent:"flex-start",alignItems:"center"}},a&&e.React.createElement(E,{style:{marginRight:4}},e.React.createElement(ae.Icon,{source:a,size:"small"})),e.React.createElement(L,{style:c.mainText},n)),e.React.createElement(E,{style:c.main},s?e.React.createElement(E,{style:{paddingHorizontal:16,paddingVertical:16}},i):i))}function re(t){let{addPadding:n}=t;const a=e.stylesheet.createThemedStyleSheet({line:{width:"100%",marginHorizontal:n&&16,height:2,backgroundColor:ie(f.semanticColors.BACKGROUND_ACCENT),marginTop:8,marginBottom:8}});return e.React.createElement(E,{style:a.line})}var A;(function(t){function n(a){let{children:i}=a;return e.React.createElement(L,{style:ne["text-md/bold"]},i)}t.Bold=n})(A||(A={}));function ce(t){let{onPress:n,icon:a,style:i,destructive:s}=t;const c=e.stylesheet.createThemedStyleSheet({headerStyleIcon:{marginRight:10,tintColor:f.semanticColors.HEADER_PRIMARY},cardStyleIcon:{width:22,height:22,marginLeft:5,tintColor:f.semanticColors.INTERACTIVE_NORMAL},destructiveIcon:{tintColor:f.semanticColors.TEXT_DANGER}});return e.React.createElement(e.ReactNative.TouchableOpacity,{onPress:n},e.React.createElement(e.ReactNative.Image,{style:[typeof i=="string"?i==="header"?c.headerStyleIcon:c.cardStyleIcon:i,s&&c.destructiveIcon].filter(function(h){return!!h}),source:a}))}const{View:le,Text:k}=o.General,{TextStyleSheet:F}=R.findByProps("TextStyleSheet"),U=e.stylesheet.createThemedStyleSheet({count:{...F["text-lg/bold"],color:f.semanticColors.TEXT_NORMAL,textAlign:"center"},subtitle:{...F["text-md/medium"],color:f.semanticColors.TEXT_MUTED,textAlign:"center"}});function j(t){let{subtitle:n,count:a,contents:i}=t;return React.createElement(le,{style:{alignItems:"center",justifyContent:"center",marginHorizontal:16}},React.createElement(k,{style:U.count},a),React.createElement(k,{style:U.subtitle},n))}const C="https://vd-cloudsync.nexpid.workers.dev/",$={clientId:"1120793656878714913",redirectURL:`${C}api/oauth2-response`};async function se(t){const n=await fetch(`${C}api/oauth2-response?code=${encodeURIComponent(t)}&vendetta=true`);if(n.status===200)return await n.text();throw(await n.json())?.message}async function oe(){if(!r.authorization)return;const t=await fetch(`${C}api/get-data`,{headers:{authorization:r.authorization}});if(t.status===200)return await t.json();throw(await t.json())?.message}async function V(t){if(!r.authorization)return;const n=await fetch(`${C}api/sync-data`,{method:"POST",headers:{authorization:r.authorization,"content-type":"application/json"},body:JSON.stringify(t)});if(n.status===200)return await n.json();throw(await n.json())?.message}async function ue(){if(!r.authorization)return;const t=await fetch(`${C}api/delete-data`,{method:"DELETE",headers:{authorization:r.authorization}});if(t.status===200)return await t.json();throw(await t.json())?.message}const{pushModal:de,popModal:ge}=R.findByProps("pushModal","popModal"),he=R.findByName("OAuth2AuthorizeModal");function ye(){de({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:he,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:$.clientId,redirectUri:$.redirectURL,scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function(t){let{location:n}=t;try{const a=new URL(n).searchParams.get("code"),i=await se(a);r.authorization=i,B(),y.showToast("Successfully authenticated",l.getAssetIDByName("Check"))}catch(a){y.showToast(a?.message??a?.toString()??"An error occured during authentication",l.getAssetIDByName("Small"))}},dismissOAuthModal:function(){return ge("oauth2-authorize")}},closable:!0}})}const fe=window.nativeModuleProxy.BundleUpdaterManager;async function G(){const t={themes:[],plugins:[]};for(const n of Object.values(v.plugins.plugins)){const a=r.pluginSettings[n.id];if(a?.syncPlugin===!1)continue;const i=a?.syncStorage===!1?{}:await m.createMMKVBackend(n.id).get();t.plugins.push({id:n.id,enabled:n.enabled,options:i})}for(const n of Object.values(v.themes.themes))t.themes.push({id:n.id,enabled:n.selected});return t}async function Re(t){if(!g.save)return;let n=!1;const a=g.save.sync.plugins.filter(function(c){return!Object.keys(v.plugins.plugins).includes(c.id)});a.length>0&&await b(t,"Install Plugins",["Would you like to install ",React.createElement(A.Bold,null,a.length.toString()),` new plugin${a.length!==1?"s":""}?`],async function(){n=!0;for(const c of a)m.createMMKVBackend(c.id).set(c.options),await O.installPlugin(c.id,c.enabled);y.showToast("Synced plugins",l.getAssetIDByName("Check"))});let i;const s=g.save.sync.themes.filter(function(c){return!Object.keys(v.themes.themes).includes(c.id)});s.length>0&&await b(t,"Install Themes",["Would you like to install ",React.createElement(A.Bold,null,s.length.toString()),` new theme${s.length!==1?"s":""}?`],async function(){n=!0;for(const c of s)c.enabled&&(i=c.id),await N.installTheme(c.id);y.showToast("Synced themes",l.getAssetIDByName("Check"))}),i&&await b(t,"Reload Required","A reload is required to apply the theme. Would you like to reload?",async function(){await N.fetchTheme(i,!0),fe.reload()}),n||y.showToast("Already synced",l.getAssetIDByName("ic_sync_24px"))}const H=R.findByProps("isTablet"),{Text:Se,View:pe}=o.General,{FormRow:Ee}=o.Forms,{TextStyleSheet:J}=R.findByProps("TextStyleSheet"),K=e.stylesheet.createThemedStyleSheet({text:{...J["text-md/medium"],color:f.semanticColors.TEXT_NORMAL},button:{...J["text-md/medium"],color:f.semanticColors.TEXT_NORMAL,borderRadius:8}});function we(){const[t,n]=e.React.useState({});return r.authorization?e.React.createElement(pe,{style:{flexDirection:H.isTablet?"row":"column",justifyContent:"flex-end"}},[{text:"Sync Data",onPress:async function(a){a(!0);try{g.save=await V(await G()),w(),y.showToast("Successfully synced data",l.getAssetIDByName("Check"))}catch(i){y.showToast(`Failed to sync data: ${i}`,l.getAssetIDByName("Small"))}a(!1)}},{text:"Load Data",onPress:async function(a){a(!0),await Re(!0),a(!1)}}].map(function(a,i){const s=i!==0?8:0;return e.React.createElement(o.Button,{text:a.text,color:"green",size:"small",onPress:function(){return!t[i]&&a.onPress(function(c){n({...t,[i]:!!c})})},trailing:e.React.createElement(Ee.Icon,{source:l.getAssetIDByName("Check")}),loading:t[i],style:{...K.button,...H.isTablet?{marginLeft:s}:{marginTop:s}}})})):e.React.createElement(Se,{style:{...K.text,textAlign:"center"}},"Authenticate first to manage your data")}const{FormSwitchRow:W}=o.Forms;function Te(){const[t,n]=e.React.useState(""),[,a]=e.React.useReducer(function(i){return~i},0);return e.React.useEffect(function(){n("")},[]),m.useProxy(r),e.NavigationNative.useNavigation().setOptions({title:"Plugin Settings",headerRight:function(){return e.React.createElement(ce,{onPress:function(){return M.showConfirmationAlert({title:"Revert Settings",content:"Would you like to revert all plugin settings?",confirmText:"Revert",cancelText:"Cancel",confirmColor:"red",onConfirm:function(){return r.pluginSettings={}}})},icon:l.getAssetIDByName("ic_message_delete"),style:"header"})}}),e.React.createElement(e.ReactNative.FlatList,{ListHeaderComponent:e.React.createElement(o.Search,{style:{marginBottom:10},onChangeText:function(i){return n(i.toLowerCase())}}),style:{paddingHorizontal:10,paddingTop:10},contentContainerStyle:{paddingBottom:20},data:Object.entries(v.plugins.plugins).filter(function(i){return i[1].manifest.name?.toLowerCase().includes(t)}),renderItem:function(i){let{item:[s,c]}=i;const h=r.pluginSettings[s]??{syncPlugin:!0,syncStorage:!0},S=function(){h.syncPlugin===!0&&h.syncStorage===!0?delete r.pluginSettings[s]:r.pluginSettings[s]=h,a()};return e.React.createElement(o.Summary,{label:c.manifest.name,icon:c.manifest.vendetta.icon??":3"},e.React.createElement(W,{label:"Sync Plugin",onValueChange:function(){h.syncPlugin=!h.syncPlugin,S()},value:h.syncPlugin}),e.React.createElement(W,{label:"Sync Plugin Storage",onValueChange:function(){h.syncStorage=!h.syncStorage,S()},value:h.syncStorage}))}})}const{ScrollView:me,View:ve}=o.General,{FormRow:u,FormSwitchRow:X}=o.Forms;function Y(){const[,t]=e.React.useReducer(function(a){return~a},0);m.useProxy(r),d.cacheUpd.push(t),e.React.useEffect(function(){return function(){d.cacheUpd=d.cacheUpd.filter(function(a){return a!==t})}},[]);const n=e.NavigationNative.useNavigation();return n.setOptions({title:"Cloud Sync Settings"}),e.React.createElement(me,null,e.React.createElement(I,{title:"Current Data",icon:l.getAssetIDByName("ic_contact_sync"),padding:!0},e.React.createElement(ve,{style:{flexDirection:"row",alignItems:"center",justifyContent:"center",marginVertical:8}},e.React.createElement(j,{count:g.save?.sync?.plugins?.length??"-",subtitle:"plugins",contents:2}),e.React.createElement(j,{count:g.save?.sync?.themes?.length??"-",subtitle:"themes",contents:2}))),e.React.createElement(I,{title:"Settings",icon:l.getAssetIDByName("ic_cog_24px")},e.React.createElement(X,{label:"Auto Sync",subLabel:"Automatically sync data to cloud",leading:e.React.createElement(u.Icon,{source:l.getAssetIDByName("ic_contact_sync")}),onValueChange:function(){return r.autoSync=!r.autoSync},value:r.autoSync}),e.React.createElement(X,{label:"Add To Settings",subLabel:"Add Cloud Sync to the settings page",leading:e.React.createElement(u.Icon,{source:l.getAssetIDByName("ic_message_pin")}),onValueChange:function(){return r.addToSettings=!r.addToSettings},value:r.addToSettings}),e.React.createElement(u,{label:"Plugin Settings",leading:e.React.createElement(u.Icon,{source:l.getAssetIDByName("debug")}),trailing:e.React.createElement(u.Arrow,null),onPress:function(){return n.push("VendettaCustomPage",{render:Te})}})),e.React.createElement(I,{title:"Authentication",icon:l.getAssetIDByName("lock")},r.authorization?e.React.createElement(e.React.Fragment,null,e.React.createElement(u,{label:"Log out",subLabel:"Logs you out of CloudSync",leading:e.React.createElement(u.Icon,{source:l.getAssetIDByName("ic_logout_24px")}),onPress:function(){delete r.authorization,delete g.save,w(),y.showToast("Successfully logged out",l.getAssetIDByName("ic_logout_24px"))}}),e.React.createElement(u,{label:"Delete data",subLabel:"Deletes your data and logs you out of CloudSync",leading:e.React.createElement(u.Icon,{source:l.getAssetIDByName("trash")}),onPress:async function(){await ue(),delete r.authorization,delete g.save,w(),y.showToast("Successfully deleted data",l.getAssetIDByName("trash"))}})):e.React.createElement(u,{label:"Authenticate",leading:e.React.createElement(u.Icon,{source:l.getAssetIDByName("copy")}),trailing:u.Arrow,onPress:ye})),e.React.createElement(I,{title:"Data Management",icon:l.getAssetIDByName("ic_message_edit"),padding:!0},e.React.createElement(we,null),r.authorization&&e.React.createElement(e.React.Fragment,null,e.React.createElement(re,null),e.React.createElement(u,{label:"Copy Data as JSON",leading:e.React.createElement(u.Icon,{source:l.getAssetIDByName("copy")}),onPress:function(){e.clipboard.setString(JSON.stringify(g.save??{},void 0,3)),y.showToast("Copied",l.getAssetIDByName("Check"))}}))))}let q=0;function Ce(t){clearTimeout(q),q=setTimeout(t,1500)}const{FormRow:D}=o.Forms;function Ie(){const t=e.NavigationNative.useNavigation();return React.createElement(o.ErrorBoundary,null,React.createElement(D,{label:"Cloud Sync",leading:React.createElement(D.Icon,{source:l.getAssetIDByName("ic_contact_sync")}),trailing:D.Arrow,onPress:function(){return t.push("VendettaCustomPage",{render:Y})}}))}const{FormSection:Ae}=o.Forms,be=R.findByName("UserSettingsOverviewWrapper",!1);function Ne(){let t=[],n=p.after("default",be,function(a,i){n();const s=z.findInReactTree(i.props.children,function(c){return c.type&&c.type.name==="UserSettingsOverview"});t.push(p.after("render",s.type.prototype,function(c,h){let{props:{children:S}}=h;if(!r.addToSettings)return;const Be=[e.i18n.Messages.BILLING_SETTINGS,e.i18n.Messages.PREMIUM_SETTINGS];S=z.findInReactTree(S,function(_){return _.children[1].type===Ae}).children;const ee=S.findIndex(function(_){return Be.includes(_?.props.label)});S.splice(ee===-1?4:ee,0,React.createElement(Ie,null))}))},!0);return function(){return t.forEach(function(a){return a()})}}const r=te.storage,g={};d.cacheUpd=[];function w(){d.cacheUpd.forEach(function(t){return t()})}async function B(){try{g.save=await oe()}catch{}w()}r.autoSync??=!1,r.addToSettings??=!0,r.pluginSettings??={};let T=[];const P=async function(){if(!r.autoSync)return;const t=await G();JSON.stringify(g.save)!==JSON.stringify(t)&&Ce(async function(){g.save=await V(t),w()})};async function b(t,n,a,i){return t?new Promise(function(s){M.showConfirmationAlert({title:n,content:a,confirmText:"Yes",cancelText:"No",confirmColor:"green",isDismissable:!1,onConfirm:function(){return i?.().then(s)}})}):await i?.()}const Q=function(){T.push(p.after("createMMKVBackend",m,function(t,n){T.push(p.after("set",n,function(){return P()}))}))};let Z=!1,x=!1;e.FluxDispatcher.subscribe("I18N_LOAD_SUCCESS",function(){Z=!0,x&&Q()});var De={onLoad:function(){x=!0,r.authorization&&B(),["installPlugin","startPlugin","stopPlugin","removePlugin"].forEach(function(t){return T.push(p.after(t,O,function(){return P()}))}),["installTheme","selectTheme","removeTheme"].forEach(function(t){return T.push(p.after(t,N,function(){return P()}))}),Z&&Q(),T.push(Ne())},onUnload:function(){x=!1,T.forEach(function(t){return t()})},settings:Y};return d.cache=g,d.cacheUpdated=w,d.default=De,d.fillCache=B,d.promptOrRun=b,d.vstorage=r,Object.defineProperty(d,"__esModule",{value:!0}),d})({},vendetta.plugin,vendetta.storage,vendetta.patcher,vendetta,vendetta.plugins,vendetta.themes,vendetta.ui.toasts,vendetta.ui.assets,vendetta.metro,vendetta.metro.common,vendetta.ui,vendetta.ui.components,vendetta.ui.alerts,vendetta.utils);
