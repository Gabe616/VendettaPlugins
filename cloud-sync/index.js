(function(s,H,p,v,E,D,b,y,l,R,t,f,h,x){"use strict";const{TextStyleSheet:J}=R.findByProps("TextStyleSheet"),{View:m,Text:O}=h.General,{FormRow:K}=h.Forms;function N(e){const n=R.findByProps("colors","meta"),a=R.findByStoreName("ThemeStore");return n.meta.resolveSemanticColor(a.theme,e)}function A(e){let{title:n,icon:a,children:i,padding:o}=e;const r=t.stylesheet.createThemedStyleSheet({mainText:{fontFamily:t.constants.Fonts.PRIMARY_SEMIBOLD,fontSize:14,includeFontPadding:!1,letterSpacing:void 0,lineHeight:18,textTransform:"none",color:N(f.semanticColors.HEADER_SECONDARY)},main:{backgroundColor:N(f.semanticColors.BACKGROUND_TERTIARY),borderRadius:16,overflow:"hidden",flex:1}});return React.createElement(m,{style:{marginHorizontal:16,marginTop:16}},React.createElement(m,{style:{marginBottom:8,flexDirection:"row",justifyContent:"flex-start",alignItems:"center"}},a&&React.createElement(m,{style:{marginRight:4}},React.createElement(K.Icon,{source:a,size:"small"})),React.createElement(O,{style:r.mainText},n)),React.createElement(m,{style:r.main},o?React.createElement(m,{style:{paddingHorizontal:16,paddingVertical:16}},i):i))}function X(){const e=t.stylesheet.createThemedStyleSheet({line:{width:"100%",height:2,backgroundColor:N(f.semanticColors.BACKGROUND_ACCENT),marginTop:16,marginBottom:16}});return React.createElement(m,{style:e.line})}var C;(function(e){function n(a){let{children:i}=a;return React.createElement(O,{style:J["text-md/bold"]},i)}e.Bold=n})(C||(C={}));function Y(e){let{onPress:n,icon:a,style:i,destructive:o}=e;const r=t.stylesheet.createThemedStyleSheet({headerStyleIcon:{marginRight:10,tintColor:f.semanticColors.HEADER_PRIMARY},cardStyleIcon:{width:22,height:22,marginLeft:5,tintColor:f.semanticColors.INTERACTIVE_NORMAL},destructiveIcon:{tintColor:f.semanticColors.TEXT_DANGER}});return React.createElement(t.ReactNative.TouchableOpacity,{onPress:n},React.createElement(t.ReactNative.Image,{style:[i==="header"?r.headerStyleIcon:r.cardStyleIcon,o&&r.destructiveIcon].filter(function(g){return!!g}),source:a}))}const{View:W,Text:z}=h.General,{TextStyleSheet:M}=R.findByProps("TextStyleSheet"),_=t.stylesheet.createThemedStyleSheet({count:{...M["text-lg/bold"],color:f.semanticColors.TEXT_NORMAL,textAlign:"center"},subtitle:{...M["text-md/medium"],color:f.semanticColors.TEXT_MUTED,textAlign:"center"}});function L(e){let{subtitle:n,count:a,contents:i}=e;return React.createElement(W,{style:{alignItems:"center",justifyContent:"center",marginHorizontal:16}},React.createElement(z,{style:_.count},a),React.createElement(z,{style:_.subtitle},n))}const w="https://vd-cloudsync.nexpid.workers.dev/",k={clientId:"1120793656878714913",redirectURL:`${w}api/oauth2-response`};async function q(e){const n=await fetch(`${w}api/oauth2-response?code=${encodeURIComponent(e)}&vendetta=true`);if(n.status===200)return await n.text();throw(await n.json())?.message}async function Q(){if(!c.authorization)return;const e=await fetch(`${w}api/get-data`,{headers:{authorization:c.authorization}});if(e.status===200)return await e.json();throw(await e.json())?.message}async function F(e){if(!c.authorization)return;const n=await fetch(`${w}api/sync-data`,{method:"POST",headers:{authorization:c.authorization,"content-type":"application/json"},body:JSON.stringify(e)});if(n.status===200)return await n.json();throw(await n.json())?.message}async function Z(){if(!c.authorization)return;const e=await fetch(`${w}api/delete-data`,{method:"DELETE",headers:{authorization:c.authorization}});if(e.status===200)return await e.json();throw(await e.json())?.message}const{pushModal:ee,popModal:te}=R.findByProps("pushModal","popModal"),ne=R.findByName("OAuth2AuthorizeModal");function ae(){ee({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:ne,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:k.clientId,redirectUri:k.redirectURL,scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function(e){let{location:n}=e;try{const a=new URL(n).searchParams.get("code"),i=await q(a);c.authorization=i,B(),y.showToast("Successfully authenticated",l.getAssetIDByName("Check"))}catch(a){y.showToast(a?.message??a?.toString()??"An error occured during authentication",l.getAssetIDByName("Small"))}},dismissOAuthModal:function(){return te("oauth2-authorize")}},closable:!0}})}const ie=window.nativeModuleProxy.BundleUpdaterManager;async function U(){const e={themes:[],plugins:[]};for(const n of Object.values(E.plugins.plugins)){const a=c.pluginSettings[n.id];if(a?.syncPlugin===!1)continue;const i=a?.syncStorage===!1?{}:await p.createMMKVBackend(n.id).get();e.plugins.push({id:n.id,enabled:n.enabled,options:i})}for(const n of Object.values(E.themes.themes))e.themes.push({id:n.id,enabled:n.selected});return e}async function ce(e){if(!d.save)return;let n=!1;const a=d.save.sync.plugins.filter(function(r){return!Object.keys(E.plugins.plugins).includes(r.id)});a.length>0&&await I(e,"Install Plugins",["Would you like to install ",React.createElement(C.Bold,null,a.length.toString()),` new plugin${a.length!==1?"s":""}?`],async function(){n=!0;for(const r of a)p.createMMKVBackend(r.id).set(r.options),await D.installPlugin(r.id,r.enabled);y.showToast("Synced plugins",l.getAssetIDByName("Check"))});let i;const o=d.save.sync.themes.filter(function(r){return!Object.keys(E.themes.themes).includes(r.id)});o.length>0&&await I(e,"Install Themes",["Would you like to install ",React.createElement(C.Bold,null,o.length.toString()),` new theme${o.length!==1?"s":""}?`],async function(){n=!0;for(const r of o)r.enabled&&(i=r.id),await b.installTheme(r.id);y.showToast("Synced themes",l.getAssetIDByName("Check"))}),i&&await I(e,"Reload Required","A reload is required to apply the theme. Would you like to reload?",async function(){await b.fetchTheme(i,!0),ie.reload()}),n||y.showToast("Already synced",l.getAssetIDByName("ic_sync_24px"))}const re=R.findByProps("isTablet"),{Text:le}=h.General,{FormRow:oe}=h.Forms,{TextStyleSheet:j}=R.findByProps("TextStyleSheet"),V=t.stylesheet.createThemedStyleSheet({text:{...j["text-md/medium"],color:f.semanticColors.TEXT_NORMAL},button:{...j["text-md/medium"],color:f.semanticColors.TEXT_NORMAL,borderRadius:8}});function se(){const[e,n]=t.React.useState({});return c.authorization?t.React.createElement(t.React.Fragment,null,...[{text:"Sync Data",onPress:async function(a){a(!0);try{d.save=await F(await U()),S(),y.showToast("Successfully synced data",l.getAssetIDByName("Check"))}catch(i){y.showToast(`Failed to sync data: ${i}`,l.getAssetIDByName("Small"))}a(!1)}},{text:"Load Data",onPress:async function(a){a(!0),await ce(!0),a(!1)}}].map(function(a,i,o){const r=i!==0?8:0;return t.React.createElement(h.Button,{text:a.text,color:"green",size:"small",onPress:function(){return!e[i]&&a.onPress(function(g){n({...e,[i]:!!g})})},trailing:t.React.createElement(oe.Icon,{source:l.getAssetIDByName("Check")}),loading:e[i],style:{...V.button,...re.isTablet?{flex:`0.${o.length}`,marginLeft:r}:{marginTop:r}}})})):t.React.createElement(le,{style:{...V.text,textAlign:"center"}},"Authenticate first to manage your data")}const{FormSwitchRow:$}=h.Forms;function ue(){const[e,n]=t.React.useState(""),[,a]=t.React.useReducer(function(i){return~i},0);return t.React.useEffect(function(){n("")},[]),p.useProxy(c),t.NavigationNative.useNavigation().setOptions({title:"Plugin Settings",headerRight:function(){return t.React.createElement(Y,{onPress:function(){return x.showConfirmationAlert({title:"Revert Settings",content:"Would you like to revert all plugin settings?",confirmText:"Revert",cancelText:"Cancel",confirmColor:"red",onConfirm:function(){return c.pluginSettings={}}})},icon:l.getAssetIDByName("ic_message_delete"),style:"header"})}}),t.React.createElement(t.ReactNative.FlatList,{ListHeaderComponent:t.React.createElement(h.Search,{style:{marginBottom:10},onChangeText:function(i){return n(i.toLowerCase())}}),style:{paddingHorizontal:10,paddingTop:10},contentContainerStyle:{paddingBottom:20},data:Object.entries(E.plugins.plugins).filter(function(i){return i[1].manifest.name?.toLowerCase().includes(e)}),renderItem:function(i){let{item:[o,r]}=i;const g=c.pluginSettings[o]??{syncPlugin:!0,syncStorage:!0},G=function(){g.syncPlugin===!0&&g.syncStorage===!0?delete c.pluginSettings[o]:c.pluginSettings[o]=g,a()};return t.React.createElement(h.Summary,{label:r.manifest.name,icon:r.manifest.vendetta.icon},t.React.createElement($,{label:"Sync Plugin",onValueChange:function(){g.syncPlugin=!g.syncPlugin,G()},value:g.syncPlugin}),t.React.createElement($,{label:"Sync Plugin Storage",onValueChange:function(){g.syncStorage=!g.syncStorage,G()},value:g.syncStorage}))}})}const{ScrollView:de,View:ge}=h.General,{FormRow:u,FormSwitchRow:he}=h.Forms;function ye(){const[,e]=t.React.useReducer(function(a){return~a},0);p.useProxy(c),s.cacheUpd.push(e),t.React.useEffect(function(){return function(){s.cacheUpd=s.cacheUpd.filter(function(a){return a!==e})}},[]);const n=t.NavigationNative.useNavigation();return t.React.createElement(de,null,t.React.createElement(A,{title:"Current Data",icon:l.getAssetIDByName("ic_contact_sync"),padding:!0},t.React.createElement(ge,{style:{flexDirection:"row",alignItems:"center",justifyContent:"center",marginVertical:8}},t.React.createElement(L,{count:d.save?.sync?.plugins?.length??"-",subtitle:"plugins",contents:2}),t.React.createElement(L,{count:d.save?.sync?.themes?.length??"-",subtitle:"themes",contents:2}))),t.React.createElement(A,{title:"Settings",icon:l.getAssetIDByName("ic_cog_24px")},t.React.createElement(he,{label:"Auto Sync",subLabel:"Automatically sync data to cloud",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("ic_contact_sync")}),onValueChange:function(){return c.autoSync=!c.autoSync},value:c.autoSync}),t.React.createElement(u,{label:"Plugin Settings",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("debug")}),trailing:t.React.createElement(u.Arrow,null),onPress:function(){return n.push("VendettaCustomPage",{render:ue})}})),t.React.createElement(A,{title:"Authentication",icon:l.getAssetIDByName("lock")},c.authorization?t.React.createElement(t.React.Fragment,null,t.React.createElement(u,{label:"Log out",subLabel:"Logs you out of CloudSync",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("ic_logout_24px")}),onPress:function(){delete c.authorization,delete d.save,S(),y.showToast("Successfully logged out",l.getAssetIDByName("ic_logout_24px"))}}),t.React.createElement(u,{label:"Delete data",subLabel:"Deletes your data and logs you out of CloudSync",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("trash")}),onPress:async function(){await Z(),delete c.authorization,delete d.save,S(),y.showToast("Successfully deleted data",l.getAssetIDByName("trash"))}})):t.React.createElement(u,{label:"Authenticate",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("copy")}),trailing:u.Arrow,onPress:ae})),t.React.createElement(A,{title:"Data Management",icon:l.getAssetIDByName("ic_message_edit"),padding:!0},t.React.createElement(se,null),c.authorization&&t.React.createElement(t.React.Fragment,null,t.React.createElement(X,null),t.React.createElement(u,{label:"Copy Data as JSON",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("copy")}),onPress:function(){t.clipboard.setString(JSON.stringify(d.save??{},void 0,3)),y.showToast("Copied",l.getAssetIDByName("Check"))}}))))}const c=H.storage,d={};s.cacheUpd=[];function S(){s.cacheUpd.forEach(function(e){return e()})}async function B(){try{d.save=await Q()}catch{}S()}c.autoSync??=!1,c.pluginSettings??={};let T=[];const P=async function(){if(!c.autoSync)return;const e=await U();JSON.stringify(d.save)!==JSON.stringify(e)&&(d.save=await F(e),S())};async function I(e,n,a,i){return console.log("ran promptOrRun with: ",e,n,a),e?new Promise(function(o){x.showConfirmationAlert({title:n,content:a,confirmText:"Yes",cancelText:"No",confirmColor:"green",isDismissable:!1,onConfirm:function(){return i?.().then(o)}})}):await i?.()}var fe={onLoad:function(){c.authorization&&B(),["installPlugin","startPlugin","stopPlugin","removePlugin"].forEach(function(e){return T.push(v.after(e,D,function(){return P()}))}),["installTheme","selectTheme","removeTheme"].forEach(function(e){return T.push(v.after(e,b,function(){return P()}))}),T.push(v.after("createMMKVBackend",p,function(e,n){T.push(v.after("set",n,function(){return P()}))}))},onUnload:function(){return T.forEach(function(e){return e()})},settings:ye};return s.cache=d,s.cacheUpdated=S,s.default=fe,s.fillCache=B,s.promptOrRun=I,s.vstorage=c,Object.defineProperty(s,"__esModule",{value:!0}),s})({},vendetta.plugin,vendetta.storage,vendetta.patcher,vendetta,vendetta.plugins,vendetta.themes,vendetta.ui.toasts,vendetta.ui.assets,vendetta.metro,vendetta.metro.common,vendetta.ui,vendetta.ui.components,vendetta.ui.alerts);
