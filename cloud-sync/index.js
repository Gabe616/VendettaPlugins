(function(d,ne,T,p,v,M,N,y,l,R,t,f,s,z,L){"use strict";const{TextStyleSheet:ae}=R.findByProps("TextStyleSheet"),{View:m,Text:k,Pressable:Pe}=s.General,{FormRow:ie}=s.Forms;function D(e){const n=R.findByProps("colors","meta"),a=R.findByStoreName("ThemeStore");return n.meta.resolveSemanticColor(a.theme,e)}function C(e){let{title:n,icon:a,children:i,padding:o}=e;const c=t.stylesheet.createThemedStyleSheet({mainText:{fontFamily:t.constants.Fonts.PRIMARY_SEMIBOLD,fontSize:14,includeFontPadding:!1,letterSpacing:void 0,lineHeight:18,textTransform:"none",color:D(f.semanticColors.HEADER_SECONDARY)},main:{backgroundColor:D(f.semanticColors.BACKGROUND_TERTIARY),borderRadius:16,overflow:"hidden",flex:1}});return React.createElement(m,{style:{marginHorizontal:16,marginTop:16}},React.createElement(m,{style:{marginBottom:8,flexDirection:"row",justifyContent:"flex-start",alignItems:"center"}},a&&React.createElement(m,{style:{marginRight:4}},React.createElement(ie.Icon,{source:a,size:"small"})),React.createElement(k,{style:c.mainText},n)),React.createElement(m,{style:c.main},o?React.createElement(m,{style:{paddingHorizontal:16,paddingVertical:16}},i):i))}function re(e){let{addPadding:n}=e;const a=t.stylesheet.createThemedStyleSheet({line:{width:"100%",marginHorizontal:n&&16,height:2,backgroundColor:D(f.semanticColors.BACKGROUND_ACCENT),marginTop:8,marginBottom:8}});return React.createElement(m,{style:a.line})}var A;(function(e){function n(a){let{children:i}=a;return React.createElement(k,{style:ae["text-md/bold"]},i)}e.Bold=n})(A||(A={}));function ce(e){let{onPress:n,icon:a,style:i,destructive:o}=e;const c=t.stylesheet.createThemedStyleSheet({headerStyleIcon:{marginRight:10,tintColor:f.semanticColors.HEADER_PRIMARY},cardStyleIcon:{width:22,height:22,marginLeft:5,tintColor:f.semanticColors.INTERACTIVE_NORMAL},destructiveIcon:{tintColor:f.semanticColors.TEXT_DANGER}});return React.createElement(t.ReactNative.TouchableOpacity,{onPress:n},React.createElement(t.ReactNative.Image,{style:[typeof i=="string"?i==="header"?c.headerStyleIcon:c.cardStyleIcon:i,o&&c.destructiveIcon].filter(function(h){return!!h}),source:a}))}const{View:le,Text:F}=s.General,{TextStyleSheet:U}=R.findByProps("TextStyleSheet"),j=t.stylesheet.createThemedStyleSheet({count:{...U["text-lg/bold"],color:f.semanticColors.TEXT_NORMAL,textAlign:"center"},subtitle:{...U["text-md/medium"],color:f.semanticColors.TEXT_MUTED,textAlign:"center"}});function V(e){let{subtitle:n,count:a,contents:i}=e;return React.createElement(le,{style:{alignItems:"center",justifyContent:"center",marginHorizontal:16}},React.createElement(F,{style:j.count},a),React.createElement(F,{style:j.subtitle},n))}const I="https://vd-cloudsync.nexpid.workers.dev/",$={clientId:"1120793656878714913",redirectURL:`${I}api/oauth2-response`};async function oe(e){const n=await fetch(`${I}api/oauth2-response?code=${encodeURIComponent(e)}&vendetta=true`);if(n.status===200)return await n.text();throw(await n.json())?.message}async function se(){if(!r.authorization)return;const e=await fetch(`${I}api/get-data`,{headers:{authorization:r.authorization}});if(e.status===200)return await e.json();throw(await e.json())?.message}async function G(e){if(!r.authorization)return;const n=await fetch(`${I}api/sync-data`,{method:"POST",headers:{authorization:r.authorization,"content-type":"application/json"},body:JSON.stringify(e)});if(n.status===200)return await n.json();throw(await n.json())?.message}async function ue(){if(!r.authorization)return;const e=await fetch(`${I}api/delete-data`,{method:"DELETE",headers:{authorization:r.authorization}});if(e.status===200)return await e.json();throw(await e.json())?.message}const{pushModal:de,popModal:ge}=R.findByProps("pushModal","popModal"),he=R.findByName("OAuth2AuthorizeModal");function ye(){de({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:he,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:$.clientId,redirectUri:$.redirectURL,scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function(e){let{location:n}=e;try{const a=new URL(n).searchParams.get("code"),i=await oe(a);r.authorization=i,P(),y.showToast("Successfully authenticated",l.getAssetIDByName("Check"))}catch(a){y.showToast(a?.message??a?.toString()??"An error occured during authentication",l.getAssetIDByName("Small"))}},dismissOAuthModal:function(){return ge("oauth2-authorize")}},closable:!0}})}const fe=window.nativeModuleProxy.BundleUpdaterManager;async function H(){const e={themes:[],plugins:[]};for(const n of Object.values(v.plugins.plugins)){const a=r.pluginSettings[n.id];if(a?.syncPlugin===!1)continue;const i=a?.syncStorage===!1?{}:await T.createMMKVBackend(n.id).get();e.plugins.push({id:n.id,enabled:n.enabled,options:i})}for(const n of Object.values(v.themes.themes))e.themes.push({id:n.id,enabled:n.selected});return e}async function Re(e){if(!g.save)return;let n=!1;const a=g.save.sync.plugins.filter(function(c){return!Object.keys(v.plugins.plugins).includes(c.id)});a.length>0&&await b(e,"Install Plugins",["Would you like to install ",React.createElement(A.Bold,null,a.length.toString()),` new plugin${a.length!==1?"s":""}?`],async function(){n=!0;for(const c of a)T.createMMKVBackend(c.id).set(c.options),await M.installPlugin(c.id,c.enabled);y.showToast("Synced plugins",l.getAssetIDByName("Check"))});let i;const o=g.save.sync.themes.filter(function(c){return!Object.keys(v.themes.themes).includes(c.id)});o.length>0&&await b(e,"Install Themes",["Would you like to install ",React.createElement(A.Bold,null,o.length.toString()),` new theme${o.length!==1?"s":""}?`],async function(){n=!0;for(const c of o)c.enabled&&(i=c.id),await N.installTheme(c.id);y.showToast("Synced themes",l.getAssetIDByName("Check"))}),i&&await b(e,"Reload Required","A reload is required to apply the theme. Would you like to reload?",async function(){await N.fetchTheme(i,!0),fe.reload()}),n||y.showToast("Already synced",l.getAssetIDByName("ic_sync_24px"))}const J=R.findByProps("isTablet"),{Text:Se,View:pe}=s.General,{FormRow:me}=s.Forms,{TextStyleSheet:K}=R.findByProps("TextStyleSheet"),W=t.stylesheet.createThemedStyleSheet({text:{...K["text-md/medium"],color:f.semanticColors.TEXT_NORMAL},button:{...K["text-md/medium"],color:f.semanticColors.TEXT_NORMAL,borderRadius:8}});function Ee(){const[e,n]=t.React.useState({});return r.authorization?t.React.createElement(pe,{style:{flexDirection:J.isTablet?"row":"column",justifyContent:"flex-end"}},[{text:"Sync Data",onPress:async function(a){a(!0);try{g.save=await G(await H()),E(),y.showToast("Successfully synced data",l.getAssetIDByName("Check"))}catch(i){y.showToast(`Failed to sync data: ${i}`,l.getAssetIDByName("Small"))}a(!1)}},{text:"Load Data",onPress:async function(a){a(!0),await Re(!0),a(!1)}}].map(function(a,i){const o=i!==0?8:0;return t.React.createElement(s.Button,{text:a.text,color:"green",size:"small",onPress:function(){return!e[i]&&a.onPress(function(c){n({...e,[i]:!!c})})},trailing:t.React.createElement(me.Icon,{source:l.getAssetIDByName("Check")}),loading:e[i],style:{...W.button,...J.isTablet?{marginLeft:o}:{marginTop:o}}})})):t.React.createElement(Se,{style:{...W.text,textAlign:"center"}},"Authenticate first to manage your data")}const{FormSwitchRow:X}=s.Forms;function we(){const[e,n]=t.React.useState(""),[,a]=t.React.useReducer(function(i){return~i},0);return t.React.useEffect(function(){n("")},[]),T.useProxy(r),t.NavigationNative.useNavigation().setOptions({title:"Plugin Settings",headerRight:function(){return t.React.createElement(ce,{onPress:function(){return z.showConfirmationAlert({title:"Revert Settings",content:"Would you like to revert all plugin settings?",confirmText:"Revert",cancelText:"Cancel",confirmColor:"red",onConfirm:function(){return r.pluginSettings={}}})},icon:l.getAssetIDByName("ic_message_delete"),style:"header"})}}),t.React.createElement(t.ReactNative.FlatList,{ListHeaderComponent:t.React.createElement(s.Search,{style:{marginBottom:10},onChangeText:function(i){return n(i.toLowerCase())}}),style:{paddingHorizontal:10,paddingTop:10},contentContainerStyle:{paddingBottom:20},data:Object.entries(v.plugins.plugins).filter(function(i){return i[1].manifest.name?.toLowerCase().includes(e)}),renderItem:function(i){let{item:[o,c]}=i;const h=r.pluginSettings[o]??{syncPlugin:!0,syncStorage:!0},S=function(){h.syncPlugin===!0&&h.syncStorage===!0?delete r.pluginSettings[o]:r.pluginSettings[o]=h,a()};return t.React.createElement(s.Summary,{label:c.manifest.name,icon:c.manifest.vendetta.icon??":3"},t.React.createElement(X,{label:"Sync Plugin",onValueChange:function(){h.syncPlugin=!h.syncPlugin,S()},value:h.syncPlugin}),t.React.createElement(X,{label:"Sync Plugin Storage",onValueChange:function(){h.syncStorage=!h.syncStorage,S()},value:h.syncStorage}))}})}const{ScrollView:Te,View:ve}=s.General,{FormRow:u,FormSwitchRow:Y}=s.Forms;function q(){const[,e]=t.React.useReducer(function(a){return~a},0);T.useProxy(r),d.cacheUpd.push(e),t.React.useEffect(function(){return function(){d.cacheUpd=d.cacheUpd.filter(function(a){return a!==e})}},[]);const n=t.NavigationNative.useNavigation();return n.setOptions({title:"Cloud Sync Settings"}),t.React.createElement(Te,null,t.React.createElement(C,{title:"Current Data",icon:l.getAssetIDByName("ic_contact_sync"),padding:!0},t.React.createElement(ve,{style:{flexDirection:"row",alignItems:"center",justifyContent:"center",marginVertical:8}},t.React.createElement(V,{count:g.save?.sync?.plugins?.length??"-",subtitle:"plugins",contents:2}),t.React.createElement(V,{count:g.save?.sync?.themes?.length??"-",subtitle:"themes",contents:2}))),t.React.createElement(C,{title:"Settings",icon:l.getAssetIDByName("ic_cog_24px")},t.React.createElement(Y,{label:"Auto Sync",subLabel:"Automatically sync data to cloud",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("ic_contact_sync")}),onValueChange:function(){return r.autoSync=!r.autoSync},value:r.autoSync}),t.React.createElement(Y,{label:"Add To Settings",subLabel:"Add Cloud Sync to the settings page",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("ic_message_pin")}),onValueChange:function(){return r.addToSettings=!r.addToSettings},value:r.addToSettings}),t.React.createElement(u,{label:"Plugin Settings",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("debug")}),trailing:t.React.createElement(u.Arrow,null),onPress:function(){return n.push("VendettaCustomPage",{render:we})}})),t.React.createElement(C,{title:"Authentication",icon:l.getAssetIDByName("lock")},r.authorization?t.React.createElement(t.React.Fragment,null,t.React.createElement(u,{label:"Log out",subLabel:"Logs you out of CloudSync",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("ic_logout_24px")}),onPress:function(){delete r.authorization,delete g.save,E(),y.showToast("Successfully logged out",l.getAssetIDByName("ic_logout_24px"))}}),t.React.createElement(u,{label:"Delete data",subLabel:"Deletes your data and logs you out of CloudSync",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("trash")}),onPress:async function(){await ue(),delete r.authorization,delete g.save,E(),y.showToast("Successfully deleted data",l.getAssetIDByName("trash"))}})):t.React.createElement(u,{label:"Authenticate",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("copy")}),trailing:u.Arrow,onPress:ye})),t.React.createElement(C,{title:"Data Management",icon:l.getAssetIDByName("ic_message_edit"),padding:!0},t.React.createElement(Ee,null),r.authorization&&t.React.createElement(t.React.Fragment,null,t.React.createElement(re,null),t.React.createElement(u,{label:"Copy Data as JSON",leading:t.React.createElement(u.Icon,{source:l.getAssetIDByName("copy")}),onPress:function(){t.clipboard.setString(JSON.stringify(g.save??{},void 0,3)),y.showToast("Copied",l.getAssetIDByName("Check"))}}))))}let Q=0;function Ie(e){clearTimeout(Q),Q=setTimeout(e,1500)}const{FormRow:B}=s.Forms;function Ce(){const e=t.NavigationNative.useNavigation();return React.createElement(s.ErrorBoundary,null,React.createElement(B,{label:"Cloud Sync",leading:React.createElement(B.Icon,{source:l.getAssetIDByName("ic_contact_sync")}),trailing:B.Arrow,onPress:function(){return e.push("VendettaCustomPage",{render:q})}}))}const{FormSection:Ae}=s.Forms,be=R.findByName("UserSettingsOverviewWrapper",!1);function Ne(){let e=[],n=p.after("default",be,function(a,i){n();const o=L.findInReactTree(i.props.children,function(c){return c.type&&c.type.name==="UserSettingsOverview"});e.push(p.after("render",o.type.prototype,function(c,h){let{props:{children:S}}=h;if(!r.addToSettings)return;const Be=[t.i18n.Messages.BILLING_SETTINGS,t.i18n.Messages.PREMIUM_SETTINGS];S=L.findInReactTree(S,function(O){return O.children[1].type===Ae}).children;const te=S.findIndex(function(O){return Be.includes(O?.props.label)});S.splice(te===-1?4:te,0,React.createElement(Ce,null))}))},!0);return function(){return e.forEach(function(a){return a()})}}const r=ne.storage,g={};d.cacheUpd=[];function E(){d.cacheUpd.forEach(function(e){return e()})}async function P(){try{g.save=await se()}catch{}E()}r.autoSync??=!1,r.addToSettings??=!0,r.pluginSettings??={};let w=[];const x=async function(){if(!r.autoSync)return;const e=await H();JSON.stringify(g.save)!==JSON.stringify(e)&&Ie(async function(){g.save=await G(e),E()})};async function b(e,n,a,i){return e?new Promise(function(o){z.showConfirmationAlert({title:n,content:a,confirmText:"Yes",cancelText:"No",confirmColor:"green",isDismissable:!1,onConfirm:function(){return i?.().then(o)}})}):await i?.()}const Z=function(){w.push(p.after("createMMKVBackend",T,function(e,n){w.push(p.after("set",n,function(){return x()}))}))};let ee=!1,_=!1;t.FluxDispatcher.subscribe("I18N_LOAD_SUCCESS",function(){ee=!0,_&&Z()});var De={onLoad:function(){_=!0,r.authorization&&P(),["installPlugin","startPlugin","stopPlugin","removePlugin"].forEach(function(e){return w.push(p.after(e,M,function(){return x()}))}),["installTheme","selectTheme","removeTheme"].forEach(function(e){return w.push(p.after(e,N,function(){return x()}))}),ee&&Z(),w.push(Ne())},onUnload:function(){_=!1,w.forEach(function(e){return e()})},settings:q};return d.cache=g,d.cacheUpdated=E,d.default=De,d.fillCache=P,d.promptOrRun=b,d.vstorage=r,Object.defineProperty(d,"__esModule",{value:!0}),d})({},vendetta.plugin,vendetta.storage,vendetta.patcher,vendetta,vendetta.plugins,vendetta.themes,vendetta.ui.toasts,vendetta.ui.assets,vendetta.metro,vendetta.metro.common,vendetta.ui,vendetta.ui.components,vendetta.ui.alerts,vendetta.utils);
