(function(l,H,p,v,E,D,b,h,i,f,g,y,m,x){"use strict";const{TextStyleSheet:J}=f.findByProps("TextStyleSheet"),{View:R,Text:O}=m.General,{FormRow:K}=m.Forms;function N(e){const t=f.findByProps("colors","meta"),n=f.findByStoreName("ThemeStore");return t.meta.resolveSemanticColor(n.theme,e)}function C(e){let{title:t,icon:n,children:a,padding:r}=e;const c=g.stylesheet.createThemedStyleSheet({mainText:{fontFamily:g.constants.Fonts.PRIMARY_SEMIBOLD,fontSize:14,includeFontPadding:!1,letterSpacing:void 0,lineHeight:18,textTransform:"none",color:N(y.semanticColors.HEADER_SECONDARY)},main:{backgroundColor:N(y.semanticColors.BACKGROUND_TERTIARY),borderRadius:16,overflow:"hidden",flex:1}});return React.createElement(R,{style:{marginHorizontal:16,marginTop:16}},React.createElement(R,{style:{marginBottom:8,flexDirection:"row",justifyContent:"flex-start",alignItems:"center"}},n&&React.createElement(R,{style:{marginRight:4}},React.createElement(K.Icon,{source:n,size:"small"})),React.createElement(O,{style:c.mainText},t)),React.createElement(R,{style:c.main},r?React.createElement(R,{style:{paddingHorizontal:16,paddingVertical:16}},a):a))}function X(){const e=g.stylesheet.createThemedStyleSheet({line:{width:"100%",height:2,backgroundColor:N(y.semanticColors.BACKGROUND_ACCENT),marginTop:16,marginBottom:16}});return React.createElement(R,{style:e.line})}var A;(function(e){function t(n){let{children:a}=n;return React.createElement(O,{style:J["text-md/bold"]},a)}e.Bold=t})(A||(A={}));function Y(e){let{onPress:t,icon:n,style:a,destructive:r}=e;const c=g.stylesheet.createThemedStyleSheet({headerStyleIcon:{marginRight:10,tintColor:y.semanticColors.HEADER_PRIMARY},cardStyleIcon:{width:22,height:22,marginLeft:5,tintColor:y.semanticColors.INTERACTIVE_NORMAL},destructiveIcon:{tintColor:y.semanticColors.TEXT_DANGER}});return React.createElement(g.ReactNative.TouchableOpacity,{onPress:t},React.createElement(g.ReactNative.Image,{style:[a==="header"?c.headerStyleIcon:c.cardStyleIcon,r&&c.destructiveIcon].filter(function(d){return!!d}),source:n}))}const{View:W,Text:z}=m.General,{TextStyleSheet:M}=f.findByProps("TextStyleSheet"),_=g.stylesheet.createThemedStyleSheet({count:{...M["text-lg/bold"],color:y.semanticColors.TEXT_NORMAL,textAlign:"center"},subtitle:{...M["text-md/medium"],color:y.semanticColors.TEXT_MUTED,textAlign:"center"}});function L(e){let{subtitle:t,count:n,contents:a}=e;return React.createElement(W,{style:{alignItems:"center",justifyContent:"center",marginHorizontal:16}},React.createElement(z,{style:_.count},n),React.createElement(z,{style:_.subtitle},t))}const w="https://vd-cloudsync.nexpid.workers.dev/",k={clientId:"1120793656878714913",redirectURL:`${w}api/oauth2-response`};async function q(e){const t=await fetch(`${w}api/oauth2-response?code=${encodeURIComponent(e)}&vendetta=true`);if(t.status===200)return await t.text();throw(await t.json())?.message}async function Q(){if(!o.authorization)return;const e=await fetch(`${w}api/get-data`,{headers:{authorization:o.authorization}});if(e.status===200)return await e.json();throw(await e.json())?.message}async function F(e){if(!o.authorization)return;const t=await fetch(`${w}api/sync-data`,{method:"POST",headers:{authorization:o.authorization,"content-type":"application/json"},body:JSON.stringify(e)});if(t.status===200)return await t.json();throw(await t.json())?.message}async function Z(){if(!o.authorization)return;const e=await fetch(`${w}api/delete-data`,{method:"DELETE",headers:{authorization:o.authorization}});if(e.status===200)return await e.json();throw(await e.json())?.message}const{pushModal:ee,popModal:te}=f.findByProps("pushModal","popModal"),ne=f.findByName("OAuth2AuthorizeModal");function ae(){ee({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:ne,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:k.clientId,redirectUri:k.redirectURL,scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function(e){let{location:t}=e;try{const n=new URL(t).searchParams.get("code"),a=await q(n);o.authorization=a,B(),h.showToast("Successfully authenticated",i.getAssetIDByName("Check"))}catch(n){h.showToast(n?.message??n?.toString()??"An error occured during authentication",i.getAssetIDByName("Small"))}},dismissOAuthModal:function(){return te("oauth2-authorize")}},closable:!0}})}const oe=window.nativeModuleProxy.BundleUpdaterManager;async function U(){const e={themes:[],plugins:[]};for(const t of Object.values(E.plugins.plugins)){const n=o.pluginSettings[t.id];if(n?.syncPlugin===!1)continue;const a=n?.syncStorage===!1?{}:await p.createMMKVBackend(t.id).get();e.plugins.push({id:t.id,enabled:t.enabled,options:a})}for(const t of Object.values(E.themes.themes))e.themes.push({id:t.id,enabled:t.selected});return e}async function ce(e){if(!u.save)return;let t=!1;const n=u.save.sync.plugins.filter(function(c){return!Object.keys(E.plugins.plugins).includes(c.id)});n.length>0&&await I(e,"Install Plugins",["Would you like to install ",React.createElement(A.Bold,null,n.length.toString()),` new plugin${n.length!==1?"s":""}?`],async function(){t=!0;for(const c of n)p.createMMKVBackend(c.id).set(c.options),await D.installPlugin(c.id,c.enabled);h.showToast("Synced plugins",i.getAssetIDByName("Check"))});let a;const r=u.save.sync.themes.filter(function(c){return!Object.keys(E.themes.themes).includes(c.id)});r.length>0&&await I(e,"Install Themes",["Would you like to install ",React.createElement(A.Bold,null,r.length.toString()),` new theme${r.length!==1?"s":""}?`],async function(){t=!0;for(const c of r)c.enabled&&(a=c.id),await b.installTheme(c.id);h.showToast("Synced themes",i.getAssetIDByName("Check"))}),a&&await I(e,"Reload Required","A reload is required to apply the theme. Would you like to reload?",async function(){await b.fetchTheme(a,!0),oe.reload()}),t||h.showToast("Already synced",i.getAssetIDByName("ic_sync_24px"))}const ie=f.findByProps("isTablet"),{Text:re}=m.General,{FormRow:le}=m.Forms,{TextStyleSheet:j}=f.findByProps("TextStyleSheet"),V=g.stylesheet.createThemedStyleSheet({text:{...j["text-md/medium"],color:y.semanticColors.TEXT_NORMAL},button:{...j["text-md/medium"],color:y.semanticColors.TEXT_NORMAL,borderRadius:8}});function se(){const[e,t]=React.useState({});return o.authorization?React.createElement(React.Fragment,null,...[{text:"Sync Data",onPress:async function(n){n(!0);try{u.save=await F(await U()),S(),h.showToast("Successfully synced data",i.getAssetIDByName("Check"))}catch(a){h.showToast(`Failed to sync data: ${a}`,i.getAssetIDByName("Small"))}n(!1)}},{text:"Load Data",onPress:async function(n){n(!0),await ce(!0),n(!1)}}].map(function(n,a,r){const c=a!==0?8:0;return React.createElement(m.Button,{text:n.text,color:"green",size:"small",onPress:function(){return!e[a]&&n.onPress(function(d){t({...e,[a]:!!d})})},trailing:React.createElement(le.Icon,{source:i.getAssetIDByName("Check")}),loading:e[a],style:{...V.button,...ie.isTablet?{flex:`0.${r.length}`,marginLeft:c}:{marginTop:c}}})})):React.createElement(re,{style:{...V.text,textAlign:"center"}},"Authenticate first to manage your data")}const{FormSwitchRow:$}=m.Forms;function ue(){const[e,t]=React.useState(""),[,n]=React.useReducer(function(a){return~a},0);return React.useEffect(function(){t("")},[]),p.useProxy(o),g.NavigationNative.useNavigation().setOptions({title:"Plugin Settings",headerRight:function(){return React.createElement(Y,{onPress:function(){return x.showConfirmationAlert({title:"Revert Settings",content:"Would you like to revert all plugin settings?",confirmText:"Revert",cancelText:"Cancel",confirmColor:"red",onConfirm:function(){return o.pluginSettings={}}})},icon:i.getAssetIDByName("ic_message_delete"),style:"header"})}}),React.createElement(g.ReactNative.FlatList,{ListHeaderComponent:React.createElement(m.Search,{style:{marginBottom:10},onChangeText:function(a){return t(a.toLowerCase())}}),style:{paddingHorizontal:10,paddingTop:10},contentContainerStyle:{paddingBottom:20},data:Object.entries(E.plugins.plugins).filter(function(a){return a[1].manifest.name?.toLowerCase().includes(e)}),renderItem:function(a){let{item:[r,c]}=a;const d=o.pluginSettings[r]??{syncPlugin:!0,syncStorage:!0},G=function(){d.syncPlugin===!0&&d.syncStorage===!0?delete o.pluginSettings[r]:o.pluginSettings[r]=d,n()};return React.createElement(m.Summary,{label:c.manifest.name,icon:c.manifest.vendetta.icon},React.createElement($,{label:"Sync Plugin",onValueChange:function(){d.syncPlugin=!d.syncPlugin,G()},value:d.syncPlugin}),React.createElement($,{label:"Sync Plugin Storage",onValueChange:function(){d.syncStorage=!d.syncStorage,G()},value:d.syncStorage}))}})}const{ScrollView:de,View:ge}=m.General,{FormRow:s,FormSwitchRow:me}=m.Forms;function he(){const[,e]=React.useReducer(function(n){return~n},0);p.useProxy(o),l.cacheUpd.push(e),React.useEffect(function(){return function(){l.cacheUpd=l.cacheUpd.filter(function(n){return n!==e})}},[]);const t=g.NavigationNative.useNavigation();return React.createElement(de,null,React.createElement(C,{title:"Current Data",icon:i.getAssetIDByName("ic_contact_sync"),padding:!0},React.createElement(ge,{style:{flexDirection:"row",alignItems:"center",justifyContent:"center",marginVertical:8}},React.createElement(L,{count:u.save?.sync?.plugins?.length??"-",subtitle:"plugins",contents:2}),React.createElement(L,{count:u.save?.sync?.themes?.length??"-",subtitle:"themes",contents:2}))),React.createElement(C,{title:"Settings",icon:i.getAssetIDByName("ic_cog_24px")},React.createElement(me,{label:"Auto Sync",subLabel:"Automatically sync data to cloud",leading:React.createElement(s.Icon,{source:i.getAssetIDByName("ic_contact_sync")}),onValueChange:function(){return o.autoSync=!o.autoSync},value:o.autoSync}),React.createElement(s,{label:"Plugin Settings",leading:React.createElement(s.Icon,{source:i.getAssetIDByName("debug")}),trailing:React.createElement(s.Arrow,null),onPress:function(){return t.push("VendettaCustomPage",{render:ue})}})),React.createElement(C,{title:"Authentication",icon:i.getAssetIDByName("lock")},o.authorization?React.createElement(React.Fragment,null,React.createElement(s,{label:"Log out",subLabel:"Logs you out of CloudSync",leading:React.createElement(s.Icon,{source:i.getAssetIDByName("ic_logout_24px")}),onPress:function(){delete o.authorization,delete u.save,S(),h.showToast("Successfully logged out",i.getAssetIDByName("ic_logout_24px"))}}),React.createElement(s,{label:"Delete data",subLabel:"Deletes your data and logs you out of CloudSync",leading:React.createElement(s.Icon,{source:i.getAssetIDByName("trash")}),onPress:async function(){await Z(),delete o.authorization,delete u.save,S(),h.showToast("Successfully deleted data",i.getAssetIDByName("trash"))}})):React.createElement(s,{label:"Authenticate",leading:React.createElement(s.Icon,{source:i.getAssetIDByName("copy")}),trailing:s.Arrow,onPress:ae})),React.createElement(C,{title:"Data Management",icon:i.getAssetIDByName("ic_message_edit"),padding:!0},React.createElement(se,null),o.authorization&&React.createElement(React.Fragment,null,React.createElement(X,null),React.createElement(s,{label:"Copy Data as JSON",leading:React.createElement(s.Icon,{source:i.getAssetIDByName("copy")}),onPress:function(){g.clipboard.setString(JSON.stringify(u.save??{},void 0,3)),h.showToast("Copied",i.getAssetIDByName("Check"))}}))))}const o=H.storage,u={};l.cacheUpd=[];function S(){l.cacheUpd.forEach(function(e){return e()})}async function B(){try{u.save=await Q()}catch{}S()}o.autoSync??=!1,o.pluginSettings??={};let T=[];const P=async function(){if(!o.autoSync)return;const e=await U();JSON.stringify(u.save)!==JSON.stringify(e)&&(u.save=await F(e),S())};async function I(e,t,n,a){return console.log("ran promptOrRun with: ",e,t,n),e?new Promise(function(r){x.showConfirmationAlert({title:t,content:n,confirmText:"Yes",cancelText:"No",confirmColor:"green",isDismissable:!1,onConfirm:function(){return a?.().then(r)}})}):await a?.()}var ye={onLoad:function(){o.authorization&&B(),["installPlugin","startPlugin","stopPlugin","removePlugin"].forEach(function(e){return T.push(v.after(e,D,function(){return P()}))}),["installTheme","selectTheme","removeTheme"].forEach(function(e){return T.push(v.after(e,b,function(){return P()}))}),T.push(v.after("createMMKVBackend",p,function(e,t){T.push(v.after("set",t,function(){return P()}))}))},onUnload:function(){return T.forEach(function(e){return e()})},settings:he};return l.cache=u,l.cacheUpdated=S,l.default=ye,l.fillCache=B,l.promptOrRun=I,l.vstorage=o,Object.defineProperty(l,"__esModule",{value:!0}),l})({},vendetta.plugin,vendetta.storage,vendetta.patcher,vendetta,vendetta.plugins,vendetta.themes,vendetta.ui.toasts,vendetta.ui.assets,vendetta.metro,vendetta.metro.common,vendetta.ui,vendetta.ui.components,vendetta.ui.alerts);
